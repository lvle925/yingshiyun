# -*- coding: utf-8 -*-
"""
验证规则模块
用于检测乱码、政治敏感内容、重大时间点等
"""

import re
import logging

logger = logging.getLogger(__name__)

# 核心业务关键词
CORE_KEYWORDS = ["运势", "事业", "感情", "财运", "健康", "姻缘", "适合", "人生", "未来", "咨询", 
                 "时间", "时辰", "适合", "合适", "可以", "行吗", "什么时候", "几点"]


def is_gibberish(text: str) -> bool:
    """
    检测是否为乱码
    - 降低对格式化输入（如日期信息）的误判
    - 引入核心关键词检测
    """
    BIRTH_INFO_PATTERN = re.compile(r"(公历|农历)?\s*\d{4}-\d{1,2}-\d{1,2}\s+\d{2}:\d{2}:\d{2}\s+(男|女)")
    
    # 判断是否包含完整的出生信息格式
    is_fully_formatted = bool(BIRTH_INFO_PATTERN.search(text))
    
    if is_fully_formatted:
        cleaned_text, _ = re.subn(BIRTH_INFO_PATTERN, "", text, count=1)
        text = cleaned_text.strip()
    
    total_chars = len(text)
    
    if total_chars == 0:
        return True
    
    chinese_chars = len([c for c in text if '\u4e00' <= c <= '\u9fff'])
    
    # 宽松的中文比例检查
    if chinese_chars / total_chars < 0.2:
        if not any(keyword in text for keyword in CORE_KEYWORDS):
            return True
    
    if total_chars < 2:
        has_keyword = any(keyword in text for keyword in CORE_KEYWORDS)
        if not has_keyword:
            return True
    
    return False


def detect_sensitive_political_content(prompt: str) -> bool:
    """检测是否包含政治敏感内容"""
    sensitive_keywords = [
        "战争", "军事", "军队", "解放军", "台海", "台湾独立", "台独", "港独","中国","南海","钓鱼岛","换届","领导人","俄乌","俄罗斯和乌克兰","乌克兰和俄罗斯",
        "习近平", "毛泽东", "政治", "政府", "选举", "总统", "总理", "国防","地震","国家",
        "武器", "导弹", "航母", "战斗机", "坦克", "核武器", "起义", "暴动", "64"
    ]
    
    return any(keyword in prompt for keyword in sensitive_keywords)


def detect_finance_investment(prompt: str) -> bool:
    """检测金融/投资/彩票类关键词"""
    keywords = [
        # 金融/投资通用
        "股票", "股市", "大盘", "K线", "涨停", "跌停",  "建仓", "加仓", "清仓","股价","保险",
        "抄底", "止损", "止盈", "波段", "龙虎榜", "资金流", 
        "alpha", "beta", "热点板块",
        # 证券/基金/衍生品
        "证券", "基金", "基金代码", "公募", "私募", "ETF", "LOF", "分级", "可转债", "转债",
        "债券", "期货", "期权", "权证", "配资", "杠杆", "融券", "融资", "打新", "新股申购",
        # 理财产品
        "理财", "理财产品", "银行理财", "信托", "资管", "收益率", "稳健型", "收益型",
        # 金融市场品类
        "外汇", "黄金", "白银", "原油", "大宗", "商品期货",
        # 数字资产
        "比特币", "以太坊", "以太", "ETH", "BTC", "USDT", "稳定币", "加密货币", "数字货币", "虚拟货币", "defi",
        # 投顾表述
        "荐股", "什么股",  "基金",  "理财", "投资", "收益翻倍", "稳赚",
        # 彩票相关
        "彩票", "体彩", "福彩", "双色球", "大乐透", "竞彩", "足彩", "排列三", "排列五", "下注", "投注", "选号", "号码推荐", "预测中奖",
        # 英文关键词
        "stock", "stocks", "fund", "funds", "etf", "crypto", "bitcoin", "lottery", "lotto"
    ]
    return any(k in prompt for k in keywords)

def detect_critical_time_selection(prompt: str) -> tuple:
    """检测是否为重大事件的时间选择"""
    critical_events = {
    "急诊", "化验", "抽血", "化疗", "放疗", "透析", "治疗","看医生",
    "会诊", "转诊", "分娩", "疫苗", "接种", "打疫苗", "打针", 
    "核酸检测", "核酸", "CT检查", "核磁共振", "MRI", "B超", "超声",
    "拔牙", "种牙", "根管治疗", "近视手术", "激光矫正", "手术",
    "开药", "配药", "购药", "买药", "医保报销","看牙医",

    "招投标", "招标", "投标", "中标", "框架协议", 
    "采购", "集采", "供应商准入", "价格谈判", 
    "立项", "立项评审", "项目启动", "项目验收", 
    "并购", "兼并", "重组", "股东会", "董事会", 
    "重大合同", "重要合约",

    "法院", "应诉", "立案", "开庭", "出庭", "庭审", "判决", "裁定", 
    "调解", "执行", "强制执行", "仲裁", "仲裁申请", "证据保全", 
    "公证", "公证处", "行政复议", "行政诉讼", "行政处罚", "听证", 
    "备案", "登记备案", "罚款决定", "事故处理", "事故认定",

    "融资", "融资谈判", "路演", "股权转让", "股权激励", "增资扩股", "并表", 
    "税务筹划", "报税", "年审", "审计", "财务审计", 
    "银行开户", "证券开户", "期货开户", 
    "基金申购", "基金赎回", "买基金", "卖基金", "股票申购", "打新", "买股票", "卖股票", 
    "债券申购", "私募认购", "认购", "定投", "止损", "止盈", 
    "保险投保", "退保", "保单变更", "信用卡申请", "提额", "降额", 
    "还款", "展期", "续贷", "理财", "购买理财", "赎回理财", "信托", "资管计划",

    "认购书", "网签", "交首付", "首付款", 
    "按揭", "按揭贷款", "房贷", "商贷", "公积金贷款", "组合贷", 
    "银行面签", "抵押登记", "交房", "收房", "验房", "竣工验收", 
    "车辆贷款", "银行放款", 
    "大额消费", "大宗交易", "资产处置", "资产配置",

    "离婚", "分居", "复婚", "生子", "生娃", "备孕",
    "产假", "育儿假", "上户口", "迁户口", 
    "入学", "升学", "毕业", 
    "入职", "录用", "试用期转正", "创业", "退休", "复职", "复工", 
    "丧事", "葬礼", "治丧", "探亲", "探望长辈"
}
    
    for event in critical_events:
        if event in prompt :
            return True, "重大事件"
    
    return False, ""
